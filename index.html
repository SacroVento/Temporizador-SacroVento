<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temporizador de Meditaci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="max-w-3xl mx-auto py-10 px-5">
        <!-- Imagen de la formaci√≥n -->
        <img src="FOTO TEMPORIZADOR MEDITACION NO DUAL.png" alt="Meditaci√≥n No Dual" class="mx-auto w-7/10 mb-5">

        <!-- Temporizador -->
        <div class="text-center">
            <h1 class="text-2xl font-bold mb-3">Elige el tiempo de meditaci√≥n por fase:</h1>
            <input id="timeInput" type="number" min="1" max="60" value="15" class="text-black w-20 p-2 text-center rounded">
            <p class="mt-2">Duraci√≥n total: <span id="totalTime">60</span> minutos</p>

            <div id="timerDisplay" class="text-4xl font-bold my-10">00:00</div>
            <p id="phaseDisplay" class="text-lg font-semibold">Fase 1 de 4</p>

            <!-- Botones de control -->
            <div class="flex justify-center space-x-3 mt-5">
                <button id="startButton" class="px-5 py-2 rounded bg-[#D4AF37] hover:bg-[#C69E33]">Iniciar</button>
                <button id="pauseButton" class="px-5 py-2 rounded bg-blue-800">Pausar</button>
                <button id="resumeButton" class="px-5 py-2 rounded bg-blue-800">Reiniciar Meditaci√≥n</button>
                <button id="resetButton" class="px-5 py-2 rounded bg-gray-600">Reiniciar</button>
            </div>

            <!-- Mensaje motivacional -->
            <div id="motivationalMessage" class="mt-5 text-center text-lg font-bold hidden bg-[#D4AF37] text-black p-3 rounded"></div>
        </div>

        <!-- Espacio para registrar la experiencia -->
        <div class="mt-10">
            <textarea id="experienceInput" placeholder="Escribe tu experiencia..." class="w-full h-32 p-2 text-black rounded"></textarea>
            <button id="saveButton" class="px-5 py-2 mt-2 rounded bg-[#D4AF37]">Guardar</button>
        </div>

        <!-- Tabla de registro -->
        <div class="mt-10">
            <h2 class="text-xl font-semibold mb-3">Registro de Meditaciones</h2>
            <table id="meditationTable" class="w-full text-left table-auto border-collapse border border-gray-700">
                <thead>
                    <tr>
                        <th class="border border-gray-700 px-2 py-1">Fecha</th>
                        <th class="border border-gray-700 px-2 py-1">Hora</th>
                        <th class="border border-gray-700 px-2 py-1">Tiempo por Fase</th>
                        <th class="border border-gray-700 px-2 py-1">Tiempo Total</th>
                        <th class="border border-gray-700 px-2 py-1">Experiencia</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button id="generatePdfButton" class="px-5 py-2 mt-2 rounded bg-[#D4AF37]">Generar PDF</button>
            <button id="clearHistoryButton" class="px-5 py-2 mt-2 rounded bg-gray-600">Borrar Historial</button>
        </div>
    </div>

    <script>
        // Variables globales
        let timer;
        let timePerPhase = 15; // minutos
        let totalPhases = 4;
        let currentPhase = 1;
        let remainingTime = timePerPhase * 60; // segundos
        let isPaused = false;
        let wakeLock = null;

        const motivationalMessages = [
            "¬°Qu√© bien lo has hecho! üåü Sigue adelante, ¬°la pr√°ctica hace al maestro! üßò",
            "Eres un ser de luz radiante. ‚ú® Encuentra gratitud en este momento. üôè",
            "La paz interior es tuya. üïäÔ∏è Cada respiraci√≥n cuenta. üå¨Ô∏è",
            "¬°Maravillosa meditaci√≥n! üå∏ Sigue cultivando tu bienestar. üåø",
            "Tu constancia inspira. üåû Hoy es un gran d√≠a para la calma. üí´",
            "Contin√∫a explorando tu ser. üåé Cada paso te acerca m√°s a la paz interior. ‚ù§Ô∏è",
            "Tu energ√≠a se renueva. üîÜ Este momento es todo tuyo. üï∞Ô∏è",
            "Eres fuerte y sereno. üí™ Tu paz beneficia a todos. üåä",
            "Disfruta la tranquilidad alcanzada. üòå Sigue floreciendo. üå∑",
            "Meditaci√≥n completada con √©xito. üéâ ¬°Gran trabajo! üèÜ",
            "Encuentra alegr√≠a en la calma. üòä Hoy sembraste calma. üå±",
            "La pr√°ctica diaria transforma. üíñ Sigue dedic√°ndote con amor. üïäÔ∏è",
            "Cada instante cuenta. üï∞Ô∏è Tu progreso es notable. üåü",
            "Has dado un paso m√°s hacia la paz interior. ‚ú® Bravo. üôå",
            "El camino es el objetivo. üö∂‚Äç‚ôÇÔ∏è Sigue cultivando la calma. üå≥",
            "Has creado un oasis de tranquilidad. üèùÔ∏è Sigue practicando. üíé",
            "Respira profundo. üå¨Ô∏è Tu constancia ilumina tu ser. üåû",
            "Qu√© momento de serenidad. üåä Gracias por tu dedicaci√≥n. ‚ù§Ô∏è",
            "Un instante perfecto para agradecer. üôè Cada d√≠a mejora. üåÖ",
            "¬°Bien hecho! üåü Tu pr√°ctica beneficia a todos. üåç",
            "Eres un ejemplo de disciplina. üéØ Sigue as√≠. üïäÔ∏è",
            "La calma interior es tu mejor aliado. üåø Practica siempre. üåü",
            "Sigue buscando dentro de ti. üîç Hoy has encontrado paz. üåº",
            "Qu√© regalo te has dado. üéÅ Contin√∫a cuidando de ti. ‚ù§Ô∏è",
            "Tu compromiso es inspirador. üåü Sigue adelante. üå∏",
            "Eres capaz de todo. üåü Tu progreso es evidente. üíñ",
            "Has alcanzado un estado de calma profundo. üïäÔ∏è Bravo. üôå",
            "Qu√© momento tan significativo. ‚ú® Agradece siempre. üôè",
            "Tu pr√°ctica ilumina el mundo. üåû Sigue brillando. üåü",
            "Cada meditaci√≥n es un paso m√°s. üåä Gracias por tu esfuerzo. ‚ù§Ô∏è"
        ];

        const timeInput = document.getElementById('timeInput');
        const totalTimeDisplay = document.getElementById('totalTime');
        const timerDisplay = document.getElementById('timerDisplay');
        const phaseDisplay = document.getElementById('phaseDisplay');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const resumeButton = document.getElementById('resumeButton');
        const resetButton = document.getElementById('resetButton');
        const motivationalMessage = document.getElementById('motivationalMessage');
        const saveButton = document.getElementById('saveButton');
        const experienceInput = document.getElementById('experienceInput');
        const meditationTable = document.getElementById('meditationTable').querySelector('tbody');
        const generatePdfButton = document.getElementById('generatePdfButton');
        const clearHistoryButton = document.getElementById('clearHistoryButton');

        // Archivos de sonido
        const phaseSound = new Audio('Sonido 3 GONG.mp3');
        const endSound = new Audio('Sonido 3 GONG.mp3');

        // Wake Lock para evitar que el temporizador se detenga
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                console.error(`No se pudo activar el Wake Lock: ${err.name}, ${err.message}`);
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && wakeLock === null) {
                requestWakeLock();
            }
        });

        // Service Worker para soporte offline
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(registration => {
                console.log('Service Worker registrado:', registration.scope);
            }).catch(error => {
                console.error('Error al registrar el Service Worker:', error);
            });
        }

        // Actualiza el tiempo total basado en el input
        timeInput.addEventListener('input', () => {
            timePerPhase = parseInt(timeInput.value, 10);
            totalTimeDisplay.textContent = timePerPhase * totalPhases;
            resetTimer();
        });

        // Formatea el tiempo en mm:ss
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Inicia la meditaci√≥n
        startButton.addEventListener('click', () => {
            if (timer) return;
            requestWakeLock();
            phaseSound.play();
            timer = setInterval(() => {
                if (!isPaused) {
                    remainingTime--;
                    timerDisplay.textContent = formatTime(remainingTime);

                    if (remainingTime <= 0) {
                        phaseSound.play();
                        currentPhase++;
                        if (currentPhase > totalPhases) {
                            clearInterval(timer);
                            endSound.play();
                            releaseWakeLock();
                            displayMotivationalMessage();
                            return;
                        }
                        remainingTime = timePerPhase * 60;
                        phaseDisplay.textContent = `Fase ${currentPhase} de ${totalPhases}`;
                    }
                }
            }, 1000);
        });

        // Pausa la meditaci√≥n
        pauseButton.addEventListener('click', () => {
            isPaused = true;
            releaseWakeLock();
        });

        // Reinicia la meditaci√≥n desde donde qued√≥
        resumeButton.addEventListener('click', () => {
            isPaused = false;
            requestWakeLock();
        });

        // Reinicia todo
        resetButton.addEventListener('click', () => {
            clearInterval(timer);
            timer = null;
            releaseWakeLock();
            resetTimer();
        });

        function resetTimer() {
            clearInterval(timer);
            timer = null;
            currentPhase = 1;
            remainingTime = timePerPhase * 60;
            timerDisplay.textContent = formatTime(remainingTime);
            phaseDisplay.textContent = `Fase ${currentPhase} de ${totalPhases}`;
        }

        // Guarda la experiencia en la tabla y en LocalStorage
        saveButton.addEventListener('click', () => {
            const now = new Date();
            const experience = experienceInput.value.trim();
            if (!experience) return alert('Por favor, escribe tu experiencia antes de guardar.');

            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td class="border border-gray-700 px-2 py-1">${now.toLocaleDateString()}</td>
                <td class="border border-gray-700 px-2 py-1">${now.toLocaleTimeString()}</td>
                <td class="border border-gray-700 px-2 py-1">${timePerPhase} minutos</td>
                <td class="border border-gray-700 px-2 py-1">${timePerPhase * totalPhases} minutos</td>
                <td class="border border-gray-700 px-2 py-1">${experience}</td>
            `;
            meditationTable.appendChild(newRow);

            // Guardar en LocalStorage
            const savedMeditations = JSON.parse(localStorage.getItem('meditations')) || [];
            savedMeditations.push({
                date: now.toLocaleDateString(),
                time: now.toLocaleTimeString(),
                timePerPhase: `${timePerPhase} minutos`,
                totalTime: `${timePerPhase * totalPhases} minutos`,
                experience
            });
            localStorage.setItem('meditations', JSON.stringify(savedMeditations));

            experienceInput.value = '';
        });

        // Genera PDF
        generatePdfButton.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // A√±ade el t√≠tulo y subt√≠tulo
            doc.setFontSize(18);
            doc.text('Meditaci√≥n No Dual', 10, 10);
            doc.setFontSize(14);
            doc.text('Registro de Meditaciones', 10, 20);

            // A√±ade los datos de la tabla
            const rows = [];
            meditationTable.querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => cell.textContent);
                if (rowData.length) rows.push(rowData);
            });

            doc.autoTable({
                startY: 30,
                head: [['Fecha', 'Hora', 'Tiempo por Fase', 'Tiempo Total', 'Experiencia']],
                body: rows
            });

            doc.save('registro_meditaciones.pdf');
        });

        // Borra historial
        clearHistoryButton.addEventListener('click', () => {
            meditationTable.innerHTML = '';
            localStorage.removeItem('meditations');
        });

        // Cargar meditaci√≥n guardada desde LocalStorage
        window.onload = () => {
            const savedMeditations = JSON.parse(localStorage.getItem('meditations')) || [];
            savedMeditations.forEach(med => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td class="border border-gray-700 px-2 py-1">${med.date}</td>
                    <td class="border border-gray-700 px-2 py-1">${med.time}</td>
                    <td class="border border-gray-700 px-2 py-1">${med.timePerPhase}</td>
                    <td class="border border-gray-700 px-2 py-1">${med.totalTime}</td>
                    <td class="border border-gray-700 px-2 py-1">${med.experience}</td>
                `;
                meditationTable.appendChild(newRow);
            });
        };

        // Muestra mensaje motivacional
        function displayMotivationalMessage() {
            const randomMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
            motivationalMessage.textContent = randomMessage;
            motivationalMessage.classList.remove('hidden');
        }

        // Inicializaci√≥n
        resetTimer();
    </script>
</body>
</html>
